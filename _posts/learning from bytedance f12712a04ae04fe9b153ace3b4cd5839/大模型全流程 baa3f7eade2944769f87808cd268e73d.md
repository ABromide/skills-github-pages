# 大模型全流程

Lora_finetune_gpt2:

https://colab.research.google.com/drive/1TqU8sOjbrNQphSasR3MMZFk4HaR4zdV8?usp=sharing#scrollTo=8hTAJJjG3Xn3

# 数据

目前盗号检测依赖于特定的流程图进行人工判断，我们希望借助大模型的能力能在人审方面进行辅助。用于模型SFT的数据来源分为两部份，一小部分是真实的线上数据（具体数据见[盗号分析工具v2开发](https://bytedance.larkoffice.com/docx/FL39dZOEeoHTyMxWC1FcchjFnnb)），而另外大部分数据我们希望借助之前盗号分析工具v2的流程图进行构建。构造数据的首要目的是能覆盖尽可能全的线上用户的数据分布，同时要保留一定的可扩展性，适配之后的判断链路改变的情况。

数据构建的流程如下：

1. 盗号大模型第一版的最基本目标是替代 UML 图的判断方式，因此我们需要让大模型具备和人类专家相同的能力。因此，我们首先参考[盗号分析工具v2开发](https://bytedance.larkoffice.com/docx/FL39dZOEeoHTyMxWC1FcchjFnnb)中的 UML 图，确认盗号研判流程的研判逻辑。通过构建判断路径的节点和节点行为，并抽取影响判断的关键节点，得到对应的 JSON 格式的规则链路 `rules`。
2. 其次，根据逻辑链路，针对每个节点中所涉及的数据，我们需要构造对应的原始用户特征，以便得到的特征数据可以覆盖所有的可能的分支。同时要保证线上的用户数据能通过函数映射到构造到数据范围内，以确保数据的准确性和可用性。最后，我们将处理后的数据分组`origin_select_dict`存储在JSON数据文件中，以便后续的数据分析和应用。
3. 接下来根据现有规则构建树状结构，通过深度优先搜索（DFS）进行链路遍历，提取出所有可能的路径。对于每条路径，结合路径上的节点和分支条件，构建相应的数据`condition_zh`，以便管理和跟踪路径上的条件和特征选择状态。通过构建`condition_zh`，可以更方便后续根据链路构建对应的基础特征。
4. 路径对应的自然语言描述。这一部分是数据构造的重点，**模型的训练质量受数据质量的影响很大，**所以在构建数据的时候要格外小心和精益求精，在这一部分我们进行了大量版本更新和尝试。
    1. 第一版：为了保留一定的可扩展性，我们的首先根据之前构建的规则对应的树，在每一个节点处添加对应的描述，先不考虑上下文的逻辑性，只对该节点所对应的分支进行描述，再通过深度优先搜索（DFS）进行链路遍历，得到最初一版的自然语言描述。
    
    ```
    "查询特征": {
         "可查询时间内能查询到盗号劫持日志": "之后我查询了账号作弊记录，发现在那期间该账号存在疑似被盗的特征，这表明该账号的作弊行为很有可能是盗号引起的。",
         "可查询时间内不能查询到盗号劫持日志且账号粉丝数量低": "之后我查询了账号作弊记录，发现在那期间该账号不存在疑似被盗的特征，同时该帐号粉丝数量低，所以该帐号可能存在来源于用户本身的作弊行为。",
         "可查询时间内不能查询到盗号劫持日志且账号粉丝数量高": "之后我查询了账号作弊记录，发现在那期间该账号不存在疑似被盗的特征，同时该帐号粉丝数量高，为了提高研判准确性，该帐号应该交付给人工进行研判。"
       }
    
    ```
    
    1. 第二版：为了保证一定的逻辑性，将自然语言描述中的“事实部份”和“推断部份”分离开来，构建描述文本的时候先展示事实，再进行推论。结合二者得到最终的描述文本初步版本。
        
        ```
        "有无登录记录": {
                "没有登录记录": [
                    "用户没有作弊行为时间内的登录记录。", #事实部份，白特征
                    "为了进一步确认用户是如何被盗的，于是我继续比对了作弊与盗号行为之间的登录信息和设备信息，作弊请求比较符合劫持请求的特点。" #推断部份，描述文本
                ],
                    ....
        
        ```
        
    2. 第三版：在第二版基础上，人工修改对应的描述文本。
        1. 通过添加连接词（如“同时”“接下来”“进一步”“因为”），增强描述文本的语义性。
        2. 明确特征与分支节点之间的判断逻辑，例如特征 A 的值导致无法将其分类为某一判断结果。通过这一步骤，我们人工强化了模型的学习重点，提高了它的学习能力。。
        3. 对隐私信息进行二次模糊处理，以达到既清晰描述问题又不泄露隐私信息的平衡。
        4. 再根据人工进行调整细节。
        
        得到最后的`comment_template`。[盗号大模型-自然语言描述的人工质检](https://bytedance.larkoffice.com/docx/XHe5diL76odFAOxboVzcX904n7b)
        

最后获得我们所需要的四个基础文件，若是UML的逻辑改变，可以通过自动化程序改动少量文件即可输出对于的训练数据: rules.json,origin_select_dict.json,condition_zh.json,comment_template.json。[盗号大模型全流程记录](https://bytedance.larkoffice.com/docx/Ur43dRDeqoSN4hx4PFgcIKXInVf)

| 文件名 | 文件描述 | 举例说明 |
| --- | --- | --- |
| rules.json | UML文件的JSON格式，文件中包含着节点名字，以及节点包含着的判断条件，以及每个判断条件所指向的节点/结果。 | {       "初始步骤": "设备关联判断",        "特征查询及对应操作": {            "本人设备2个封禁账号以下": {"流向步骤": "查询特征"},            "本人设备2个封禁账号以上": {"研判结果": "作弊"}        }    },... |
| origin_select_dict.json | 所有节点对应的特征的汇总，包含特征的选取范围。 | "设备关联": [        "本人设备2个封禁帐号以下",        "本人设备2个封禁帐号以上"    ],... |
| condition_zh.json | 在构建数据的时候，对应条件分支所需要的特征。 | "本人设备2个封禁账号以下": {        "设备关联": [ "本人设备2个封禁帐号以上"]    }, |
| comment_template.json | 不同链路对应的自然语言描述，具体可参考[盗号大模型-自然语言描述的人工质检](https://bytedance.larkoffice.com/docx/XHe5diL76odFAOxboVzcX904n7b) | "本人设备2个封禁账号以上，作弊": {        "comment": ["在对该账号进行研判时，我首先检查了该账号的设备关联情况，发现该账号历史所关联的设备较多，且设备登录的账号中有多个封禁账号，这不是一个正常用户账号的属性，可能表明账号存在大量聚集和批量的行为。因此，我判断该账号可能不是一个正常用户在使用，账号归属于黑产的可能性较高。综上所述，结合设备关联特征及其对应的判断逻辑步骤，我认为该账号存在来源于用户本身的作弊行为。" ]  }, |

在构建好这几个基础的文件之后，我们就可以根据每一个对应的链路进行构建数据，得到基础的63条base数据模版。基础数据模版的“特征”部分是我们不同的，我们要使得大模型能将“特征”和“规则链路”联系起来，得到“研判结果”，我们需要构造大量符合逻辑链路判断结果的不同形式的特征组合。

[https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=Mzg3Y2ZkNjA2MTdiNTQwMWE1NWIyNWRkMWMzNGYxODFfbnVjeFdUb25VcHoxcFdTdjZYM0p3bVpWcnBIcWpTblhfVG9rZW46UEN0a2J6NFQwb052MmZ4MHN1SmM2YlpZblpkXzE3MjE3OTI4NDI6MTcyMTc5NjQ0Ml9WNA](https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=Mzg3Y2ZkNjA2MTdiNTQwMWE1NWIyNWRkMWMzNGYxODFfbnVjeFdUb25VcHoxcFdTdjZYM0p3bVpWcnBIcWpTblhfVG9rZW46UEN0a2J6NFQwb052MmZ4MHN1SmM2YlpZblpkXzE3MjE3OTI4NDI6MTcyMTc5NjQ0Ml9WNA)

但是这样构建的数据会存在两个问题：

1. 特征之间存在依赖关系。解决方法：添加特征之间的依赖关系，进行数据筛选
2. 不同链路之间存在数据不平衡问题，短链路存在大量的空特征，导致根据逻辑构造出来的数据远远大于其他链路。解决方法：进行上下采样，将数据拉至统一的水平。

最终的数据如下（举例）：

```
{
        "研判结果": "作弊",
        "结构化推理": [
            {
                "步骤": "设备关联判断",
                "账号特征": {
                    "设备关联": "本人设备2个封禁帐号以下"
                },
                "流向步骤": "查询特征"
            },
            {
                "步骤": "查询特征",
                "账号特征": {
                    "可查询时间内能否查询到盗号劫持日志": "是"
                },
                "流向步骤": "有无登录记录"
            },
            {
                "步骤": "有无登录记录",
                "账号特征": {
                    "登录记录": "有",
                    "登录端": "app端"
                },
                "流向步骤": "验签状态判断"
            },
            {
                "步骤": "验签状态判断",
                "账号特征": {
                    "验签状态": "验签无异常"
                },
                "流向步骤": "历史处罚解脱状态查询"
            },
            {
                "步骤": "历史处罚解脱状态查询",
                "账号特征": {
                    "历史处罚": "没有"
                },
                "流向步骤": "设备登录环境的安全等级"
            },
            {
                "步骤": "设备登录环境的安全等级",
                "账号特征": {
                    "设备登录环境的安全等级": "<0"
                },
                "流向步骤": "账号绑定状态查询"
            },
            {
                "步骤": "账号绑定状态查询",
                "账号特征": {
                    "绑定状态": "有",
                    "绑定环境": "可信",
                    "历史换绑": "60天内有手机号换绑"
                },
                "研判结果": "作弊"
            }
        ],
        "特征": {
            "设备关联": "本人设备2个封禁帐号以下",
            "可查询时间内能否查询到盗号劫持日志": "是",
            "粉丝数": "高",
            "登录记录": "有",
            "登录端": "app端",
            "验签状态": "验签无异常",
            "历史处罚": "没有",
            "历史解脱": "有",
            "设备登录环境的安全等级": "<0",
            "绑定状态": "有",
            "绑定环境": "可信",
            "历史换绑": "60天内有手机号换绑",
            "登录方式": "账密登录",
            "登录信息": {
                "账密登录": "密码7天内没有变更"
            }
        },
        "总结": [
            "在对该账号进行研判时，我首先检查了该账号的设备关联情况，发现该账号历史所关联的设备较少，且历史上是一个正常使用的好用户，同时用户账号历史没有被处罚过，这是一个正常用户账号的属性。之后我查询了账号作弊记录，发现在那期间该账号存在疑似被盗的特征，这表明该账号存在异常行为。为了深入探究账号异常行为的原因，我继续查询了账号的登录信息和设备信息，发现验签状态不符合劫持请求的特点。接下来我也检查了用户的处罚记录，设备的登录环境以及账号绑定状态，设备的登录环境存在异常但是绑定状态无异常。综合以上信息及其对应的判断逻辑步骤，我认为该账号更符合用户本人作弊的特点。"
        ],
        "cot": "本人设备2个封禁账号以下，可查询时间内能查询到盗号劫持日志，有登录记录且为app端登录，验签正常，账号没有被处罚过，安全等级小于0，账号在60天内通过可信设备绑定，作弊"
    },

```

# 设计方案

# 实验结果

1. 数据准备
2. 训练情况
3. 生成效果评测
4. 鲁棒性评测

# 部署应用